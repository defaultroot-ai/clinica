# üè† Ghid de Gestionare a Familiilor - Plugin Clinica

## üìã Prezentare GeneralƒÉ

Sistemul de gestionare a familiilor permite organizarea pacien»õilor √Æn familii pentru o administrare mai eficientƒÉ »ôi o experien»õƒÉ mai bunƒÉ pentru utilizatori.

### üéØ Beneficii

- **Organizare eficientƒÉ**: Pacien»õii din aceea»ôi familie sunt grupa»õi logic
- **Gestionare simplificatƒÉ**: Acces rapid la to»õi membrii unei familii
- **Rapoarte √ÆmbunƒÉtƒÉ»õite**: Statistici pe familii, nu doar pe pacien»õi individuali
- **Experien»õƒÉ utilizator**: Interfa»õƒÉ intuitivƒÉ pentru gestionarea familiilor

## üö® CorectƒÉri Recente Implementate (2025)

### Problema IdentificatƒÉ
Sistemul √Ænt√¢mpina eroarea "Capul familiei nu a fost gƒÉsit" la crearea familiilor din cauza unei probleme logice √Æn fluxul de procesare.

### Solu»õiile Implementate

#### 1. Corectarea Fluxului de Creare a Familiilor
- **Problema**: Datele de familie erau procesate √Ænainte de salvarea pacientului √Æn baza de date
- **Solu»õia**: Implementarea unui flux secven»õial corect:
  1. Crearea familiei cu ID unic
  2. Salvarea pacientului √Æn baza de date
  3. Actualizarea datelor de familie dupƒÉ salvarea pacientului

#### 2. √émbunƒÉtƒÉ»õirea Metodei `create_family()`
- Verificarea existen»õei pacientului √Ænainte de actualizare
- AdƒÉugarea metodei `update_family_head()` pentru actualizarea capului familiei
- Gestionarea corectƒÉ a cazurilor c√¢nd pacientul nu existƒÉ √ÆncƒÉ

#### 3. ValidƒÉri JavaScript √émbunƒÉtƒÉ»õite
- Validarea c√¢mpurilor de familie √Ænainte de trimiterea formularului
- Verificarea completƒÉrii numelui familiei »ôi rolului
- Validarea selec»õiei familiilor existente

#### 4. Corectarea CreƒÉrii Automate a Familiilor
- Repararea metodei `create_families_auto()` pentru a extrage corect `family_id`
- √émbunƒÉtƒÉ»õirea previzualizƒÉrii familiilor cu email-uri »ôi nume complete
- Gestionarea corectƒÉ a erorilor √Æn procesul de creare automatƒÉ

## üèóÔ∏è Structura Sistemului

### C√¢mpuri √Æn Baza de Date

Tabelul `wp_clinica_patients` a fost extins cu urmƒÉtoarele c√¢mpuri:

- **`family_id`** (INT): ID-ul unic al familiei
- **`family_role`** (ENUM): Rolul √Æn familie (head, spouse, child, parent, sibling)
- **`family_head_id`** (INT): ID-ul capului familiei
- **`family_name`** (VARCHAR): Numele familiei

### Roluri √Æn Familie

1. **`head`** - Cap de familie (mama, tata, etc.)
2. **`spouse`** - So»õ/So»õie
3. **`child`** - Copil
4. **`parent`** - PƒÉrinte (bunici, etc.)
5. **`sibling`** - Frate/SorƒÉ

## üöÄ Instalare »ôi Configurare

### Pasul 1: Actualizarea Bazei de Date

Rula»õi scriptul de actualizare:

```bash
# Accesa»õi scriptul √Æn browser
http://your-site.com/wp-content/plugins/clinica/update-family-fields.php
```

Sau rula»õi manual √Æn phpMyAdmin:

```sql
ALTER TABLE wp_clinica_patients 
ADD COLUMN family_id INT DEFAULT NULL,
ADD COLUMN family_role ENUM('head', 'spouse', 'child', 'parent', 'sibling') DEFAULT NULL,
ADD COLUMN family_head_id INT DEFAULT NULL,
ADD COLUMN family_name VARCHAR(100) DEFAULT NULL;

-- AdƒÉuga»õi indexurile pentru performan»õƒÉ
ALTER TABLE wp_clinica_patients 
ADD INDEX idx_family_id (family_id),
ADD INDEX idx_family_head_id (family_head_id),
ADD INDEX idx_family_name (family_name);
```

### Pasul 2: Verificarea Fi»ôierelor

Asigura»õi-vƒÉ cƒÉ urmƒÉtoarele fi»ôiere sunt prezente »ôi actualizate:

- `includes/class-clinica-family-manager.php` ‚úÖ (Corectat)
- `includes/class-clinica-patient-creation-form.php` ‚úÖ (Corectat)
- `includes/class-clinica-family-auto-creator.php` ‚úÖ (Corectat)
- `admin/views/families.php` ‚úÖ
- ActualizƒÉri √Æn `clinica.php` ‚úÖ

### Pasul 3: Testarea Func»õionalitƒÉ»õii

1. Accesa»õi **Clinica > Familii** √Æn meniul admin
2. Verifica»õi cƒÉ pagina se √ÆncarcƒÉ corect
3. Testa»õi crearea unei familii noi
4. Testa»õi crearea automatƒÉ a familiilor pe baza email-urilor

## üì± Utilizarea Sistemului

### Crearea unei Familii Noi

1. **Accesa»õi pagina Familii**: Clinica > Familii
2. **Clic pe "CreeazƒÉ Familie NouƒÉ"**
3. **Completa»õi informa»õiile**:
   - Numele familiei (ex: "Familia Popescu")
   - Cap de familie (op»õional - poate fi adƒÉugat ulterior)
4. **Clic pe "CreeazƒÉ familia"**

### AdƒÉugarea Membrilor √Æn Familie

1. **√én pagina Familii**, gƒÉsi»õi familia doritƒÉ
2. **Clic pe "AdaugƒÉ membru"**
3. **Selecta»õi pacientul** din lista pacien»õilor fƒÉrƒÉ familie
4. **Alege»õi rolul** √Æn familie
5. **Clic pe "AdaugƒÉ membru"**

### Crearea AutomatƒÉ a Familiilor

#### Detectarea Familiilor pe baza Email-urilor
1. **Clic pe "CreeazƒÉ Familii Automat"**
2. **Configura»õi op»õiunile**:
   - ‚úÖ CreeazƒÉ pƒÉrintele ca »ôef de familie
   - ‚úÖ Atribuie roluri automat
   - ‚úÖ Doar pacien»õii fƒÉrƒÉ familie
3. **Clic pe "DetecteazƒÉ Familii"**
4. **Verifica»õi previzualizarea** - ve»õi vedea:
   - Numele familiei
   - Email-ul de bazƒÉ
   - Fiecare membru cu:
     - Numele complet
     - Email-ul
     - Rolul atribuit automat
5. **Clic pe "CreeazƒÉ Familiile Detectate"**

#### Pattern-uri de Email Suportate
- **PƒÉrinte**: `nume@email.com`
- **Copil/Membru**: `nume+altnume@email.com`
- Sistemul detecteazƒÉ automat pattern-ul `+` pentru grupare

### Gestionarea Familiilor Existente

#### Vizualizarea Membrilor
- Fiecare familie afi»ôeazƒÉ to»õi membrii cu rolurile lor
- Membrii sunt ordona»õi logic (cap de familie, so»õ/so»õie, copii, etc.)

#### Editarea Familiilor
- Clic pe "EditeazƒÉ" pentru a modifica informa»õiile familiei
- Pute»õi schimba numele familiei sau rolurile membrilor

#### Eliminarea Membrilor
- Clic pe iconi»õa de »ôtergere l√¢ngƒÉ membru
- Confirma»õi eliminarea
- **NotƒÉ**: Pacientul nu este »ôters, doar eliminat din familie

### CƒÉutarea Familiilor

1. **Folosi»õi bara de cƒÉutare** din pagina Familii
2. **Introduce»õi** numele familiei sau al unui membru
3. **Rezultatele** se afi»ôeazƒÉ √Æn timp real

## üé® Interfa»õa Utilizator

### Pagina PrincipalƒÉ Familii

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Gestionare Familii                    [+ CreeazƒÉ] ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üìä Statistici:                                          ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îÇ
‚îÇ ‚îÇ 5 Familii‚îÇ ‚îÇ 12 FƒÉrƒÉ ‚îÇ ‚îÇ 23 Membri‚îÇ                    ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üè† Familii existente:                                   ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ Familia Popescu                    [3 membri]       ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚îú‚îÄ Ion Popescu (Cap de familie)                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚îú‚îÄ Maria Popescu (So»õie)                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚îî‚îÄ Ana Popescu (Copil)                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ [AdaugƒÉ membru] [EditeazƒÉ]                          ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Modal pentru Crearea Familii

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚úï CreeazƒÉ Familie NouƒÉ              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Numele familiei *:                  ‚îÇ
‚îÇ [Familia Popescu              ]     ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ Cap de familie (op»õional):          ‚îÇ
‚îÇ [SelecteazƒÉ un pacient ‚ñº]           ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ [CreeazƒÉ familia] [AnuleazƒÉ]        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîß Func»õionalitƒÉ»õi Avansate

### API pentru Familii

Sistemul oferƒÉ urmƒÉtoarele endpoint-uri AJAX:

```php
// Crearea unei familii
wp_ajax_clinica_create_family

// AdƒÉugarea unui membru
wp_ajax_clinica_add_family_member

// Ob»õinerea membrilor
wp_ajax_clinica_get_family_members

// Eliminarea unui membru
wp_ajax_clinica_remove_family_member

// CƒÉutarea familiilor
wp_ajax_clinica_search_families
```

### Integrarea √Æn Formularul de Creare Pacien»õi

Formularul de creare pacien»õi include acum un tab "Familie" cu op»õiuni pentru:

- Nu face parte dintr-o familie
- CreeazƒÉ o familie nouƒÉ
- AdaugƒÉ la o familie existentƒÉ

### Rapoarte »ôi Statistici

Sistemul genereazƒÉ automat statistici pentru:

- NumƒÉrul total de familii
- NumƒÉrul de pacien»õi fƒÉrƒÉ familie
- NumƒÉrul total de membri √Æn familii
- Distribu»õia pe roluri

## üõ†Ô∏è Dezvoltare »ôi Extensii

### AdƒÉugarea de Roluri Noi

Pentru a adƒÉuga roluri noi, edita»õi:

1. **Baza de date**:
```sql
ALTER TABLE wp_clinica_patients 
MODIFY COLUMN family_role ENUM('head', 'spouse', 'child', 'parent', 'sibling', 'new_role') DEFAULT NULL;
```

2. **Clasa Family Manager**:
```php
public function get_family_role_label($role) {
    $labels = array(
        'head' => 'Cap de familie',
        'spouse' => 'So»õ/So»õie',
        'child' => 'Copil',
        'parent' => 'PƒÉrinte',
        'sibling' => 'Frate/SorƒÉ',
        'new_role' => 'Noul Rol' // AdƒÉuga»õi aici
    );
    
    return isset($labels[$role]) ? $labels[$role] : $role;
}
```

### Hook-uri »ôi Filtre

Sistemul oferƒÉ urmƒÉtoarele hook-uri pentru extensii:

```php
// √énainte de crearea unei familii
do_action('clinica_before_create_family', $family_name, $head_patient_id);

// DupƒÉ crearea unei familii
do_action('clinica_after_create_family', $family_id, $family_name);

// √énainte de adƒÉugarea unui membru
do_action('clinica_before_add_family_member', $patient_id, $family_id, $family_role);

// DupƒÉ adƒÉugarea unui membru
do_action('clinica_after_add_family_member', $patient_id, $family_id, $family_role);
```

## üîç Depanare

### Probleme Comune

#### 1. C√¢mpurile pentru familie nu apar
**Solu»õie**: Rula»õi scriptul `update-family-fields.php`

#### 2. Eroare "Clasa Clinica_Family_Manager nu existƒÉ"
**Solu»õie**: Verifica»õi cƒÉ fi»ôierul este √ÆncƒÉrcat √Æn `clinica.php`

#### 3. Pagina Familii nu se √ÆncarcƒÉ
**Solu»õie**: Verifica»õi permisiunile utilizatorului

#### 4. Nu pot adƒÉuga pacien»õi √Æn familie
**Solu»õie**: Verifica»õi cƒÉ pacientul nu face deja parte dintr-o familie

### Log-uri »ôi Debug

Pentru debugging, activa»õi log-urile WordPress:

```php
// √én wp-config.php
define('WP_DEBUG', true);
define('WP_DEBUG_LOG', true);
```

### Testarea Func»õionalitƒÉ»õii

Rula»õi testele automate:

```bash
# Accesa»õi scriptul de test
http://your-site.com/wp-content/plugins/clinica/update-family-fields.php
```

## üìà Performan»õƒÉ »ôi Optimizare

### Indexuri Recomandate

Sistemul include automat indexurile necesare:

- `idx_family_id` - pentru cƒÉutƒÉri rapide pe familie
- `idx_family_head_id` - pentru rela»õii cap de familie
- `idx_family_name` - pentru cƒÉutƒÉri pe nume

### Query-uri Optimizate

Toate query-urile sunt optimizate pentru performan»õƒÉ:

```sql
-- Exemplu de query optimizat pentru membrii unei familii
SELECT p.*, u.display_name, u.user_email 
FROM wp_clinica_patients p 
LEFT JOIN wp_users u ON p.user_id = u.ID 
WHERE p.family_id = %d 
ORDER BY 
   CASE p.family_role 
       WHEN 'head' THEN 1 
       WHEN 'spouse' THEN 2 
       WHEN 'child' THEN 3 
       WHEN 'parent' THEN 4 
       WHEN 'sibling' THEN 5 
       ELSE 6 
   END,
   p.birth_date ASC
```

## üîÆ Func»õionalitƒÉ»õi Viitoare

### Planuri de Dezvoltare

1. **NotificƒÉri pentru familii** - Email-uri pentru to»õi membrii
2. **Istoric familial** - Trasabilitatea problemelor medicale
3. **ProgramƒÉri familiale** - ProgramƒÉri pentru √Æntreaga familie
4. **Rapoarte avansate** - Statistici detaliate pe familii
5. **Integrare cu programƒÉri** - Sugestii de programƒÉri pentru membrii familiei

### Contribu»õii

Pentru a contribui la dezvoltarea sistemului:

1. Fork repository-ul
2. Crea»õi o branch pentru feature
3. Implementa»õi func»õionalitatea
4. Testa»õi complet
5. Crea»õi un pull request

## üìû Suport

Pentru suport tehnic:

- **Email**: support@clinica.ro
- **Documenta»õie**: https://clinica.ro/docs
- **GitHub**: https://github.com/clinica/family-management

---

**Versiune**: 1.0.0  
**Data**: 19 Iulie 2025  
**Autor**: Clinica Team 